# 6. Permissions API для Zero-Trust безопасности

Date: 2025-01-XX

## Status

Accepted

## Context

Proxy Service работает в production окружении и должен следовать принципам Zero-Trust безопасности. Необходимо ограничить доступ приложения к системным ресурсам для минимизации attack surface.

Проблемы без ограничений:

- Приложение имеет полный доступ к файловой системе
- Доступ ко всем переменным окружения (включая секреты)
- Возможность подключения к любым сетевым хостам
- При компрометации кода злоумышленник получает полный доступ

Node.js 25+ предоставляет стабильный Permissions API, который позволяет ограничить доступ к:

- Файловой системе (`fs`)
- Переменным окружения (`env`)
- Сетевым хостам (`net`)
- Процессам (`process`)

## Decision

Использовать Node.js Permissions API для ограничения доступа Proxy Service к системным ресурсам.

### Конфигурация

Разрешения задаются через флаги командной строки Node.js:

```bash
node --permission \
  --allow-fs-read=/app \
  --allow-net
```

**Ограничения Node.js 25:**

- `--allow-fs-read` - поддерживает указание конкретных путей
- `--allow-net` - экспериментальный флаг, разрешает всю сеть (детальный контроль хостов недоступен)
- `--allow-env` - не поддерживается в Node.js 25, переменные окружения контролируются на уровне Kubernetes/Docker

Файл `permissions.json` используется как справочник разрешений (для документации).

### Реализация

1. **Запуск с ограничениями**: Используются флаги `--permission`, `--allow-fs-read`, `--allow-net`
2. **Production**: Автоматически применяются ограничения через скрипт `pnpm prod`
3. **Development**: Используется режим без ограничений (`pnpm start:permissive`) для удобства разработки
4. **Runtime проверка**: В production логируются разрешения при старте для аудита

### Разрешения

**Файловая система:**

- Чтение: `/app`, `/app/.env`, `/app/dist`, `/app/prisma`
- Запись: запрещена (proxy service не пишет файлы)

**Переменные окружения:**

- Только необходимые: `PORT`, `NODE_ENV`, `SERVICE_NAME`, `LINK_SERVICE_GRPC_URL`, и т.д.
- Полный список в `permissions.json`

**Сеть:**

- Разрешены только необходимые хосты: Link Service, OpenTelemetry, Pyroscope, localhost
- Все остальные хосты запрещены

## Consequences

### Положительные

- **Zero-Trust безопасность** - минимальные привилегии по умолчанию
- **Защита от утечек** - даже при компрометации кода доступ ограничен
- **Соответствие стандартам** - соответствует принципам Zero-Trust архитектуры
- **Аудит** - все разрешения явно задокументированы в `permissions.json`
- **Простота** - конфигурация в одном файле

### Отрицательные

- **Дополнительная конфигурация** - нужно поддерживать список разрешений
- **Риск блокировки** - при добавлении новых зависимостей нужно обновлять разрешения
- **Отладка** - ошибки доступа могут быть неочевидными

### Риски и митигация

**Риск**: Забыть добавить необходимое разрешение при добавлении новой зависимости

- **Митигация**: Runtime проверка разрешений в production, логирование при старте

**Риск**: Слишком строгие ограничения блокируют легитимные операции

- **Митигация**: Development режим без ограничений для тестирования, постепенное ужесточение

## Implementation Details

### Файлы

- `permissions.json` - справочник разрешений (для документации)
- `package.json` - скрипты с флагами `--permission`, `--allow-fs-read`, `--allow-net`
- `ops/Dockerfile` - использование permissions в контейнере
- `src/infrastructure/permissions.ts` - runtime проверка разрешений
- `src/application/bootstrap.ts` - логирование разрешений при старте

### Скрипты

- `pnpm prod` - production с ограничениями
- `pnpm start:permissive` - development без ограничений

## Alternatives Considered

### Альтернатива 1: Использовать только Docker security context

**Отклонено** - Docker security context ограничивает системные вызовы, но не ограничивает доступ Node.js к файлам/env/сети внутри контейнера

### Альтернатива 2: Использовать SELinux/AppArmor

**Отклонено** - более сложная настройка, требует root прав, менее гибко для контейнеров

### Альтернатива 3: Не использовать ограничения

**Отклонено** - нарушает принципы Zero-Trust, увеличивает attack surface

## References

- [Node.js Permissions API](https://nodejs.org/api/permissions.html)
- [Zero-Trust Architecture](https://www.nist.gov/publications/zero-trust-architecture)
- `permissions.json` - справочник разрешений
- `src/infrastructure/permissions.ts` - реализация проверки
