include:
  - local: /ops/pipelines/templates/common.yml
  - local: /ops/pipelines/templates/deploy.yml
  - local: /ops/pipelines/jobs/test.yml
  - local: /ops/pipelines/jobs/build.yml
  - local: /ops/pipelines/jobs/qa.yml
  - local: /ops/pipelines/jobs/deploy-yandex.yml
  - local: /ops/pipelines/jobs/deploy-aws.yml
  - local: /ops/pipelines/jobs/post.yml

stages:
  - test
  - build
  - qa
  - deploy
  - release

workflow:
  rules:
    # Disable renovate branch
    - if: $CI_COMMIT_REF_NAME =~ /^renovate/
      when: never
    - when: always

test:
  stage: deploy
  variables:
    RELEASE_NAME: ${CI_PROJECT_NAME}-ui
    HELM_PATH: ops/Helm/${CI_PROJECT_NAME}-ui
    REGISTRY: ${CI_REGISTRY_IMAGE}/ui-nuxt
    HELM_ARG: '--set serviceAccount.create=false --set deploy.podAnnotations.\"app\.gitlab\.com\/env\"=$CI_ENVIRONMENT_SLUG --set deploy.podAnnotations.\"app\.gitlab\.com\/app\"=$CI_PROJECT_PATH_SLUG'

    CI_COMMIT_TAG: latest

    ENVIRONMENT_NAME: yandex-staging
    ENVIRONMENT_URL: http://example.com
  trigger:
    include:
      - local: 'ops/pipelines/ui.yml'
    strategy: depend
