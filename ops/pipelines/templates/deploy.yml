.job_template_deploy: &job_deploy
  stage: deploy
  image:
    name: alpine/helm:3.1.2
    entrypoint: [""]
  script:
    - helm upgrade $RELEASE_NAME $HELM_PATH
      --install
      --force
      --wait
      --namespace=$KUBE_NAMESPACE
      --set deploy.image.tag=$CI_COMMIT_TAG
      --set deploy.image.repository=$REGISTRY
      --set deploy.podAnnotations."app\.gitlab\.com\/app"=$CI_PROJECT_PATH_SLUG
      --set deploy.podAnnotations."app\.gitlab\.com\/env"=$CI_ENVIRONMENT_SLUG $HELM_ARG;
  allow_failure: false
  except:
    - branches
  when: manual

# CUSTOM TEMPLATE ======================================================================================================
.job_template_deploy_staging: &job_deploy_staging
  extends:
    - .job_template_deploy
  environment:
    name: yandex-staging
    url: staging.example.com
  only:
    refs:
      - /^(?:0|[1-9]\d*)\.(?:0|[1-9]\d*)\.(?:0|[1-9]\d*)-rc(?:0|[1-9]\d*)$/

.job_template_deploy_production: &job_deploy_production
  extends:
    - .job_template_deploy
  environment:
    name: yandex-production
    url: production.example.com
  only:
    refs:
      - /^(?:0|[1-9]\d*)\.(?:0|[1-9]\d*)\.(?:0|[1-9]\d*)\.?(?:0|[1-9]\d*)?$/
