# YANDEX STAGING RELEASE ===============================================================================================
yandex:api-staging:
  stage: deploy
  variables:
    RELEASE_NAME: ${CI_PROJECT_NAME}-api
    HELM_PATH: ops/Helm/${CI_PROJECT_NAME}-api
    REGISTRY: ${CI_REGISTRY_IMAGE}/api
    HELM_ARG: '--set deploy.podAnnotations[0].app\.gitlab\.com\/env=$CI_ENVIRONMENT_SLUG --set deploy.podAnnotations[1].app\.gitlab\.com\/app=$CI_PROJECT_PATH_SLUG'

    ENVIRONMENT_NAME: yandex-staging
    ENVIRONMENT_URL: http://example.com
  trigger:
    include:
      - local: 'ops/pipelines/deploy.yml'
    strategy: depend
  needs:
    - trigger:build_api
  rules:
    - if: '$CI_COMMIT_TAG =~ /^(?:0|[1-9]\d*)\.(?:0|[1-9]\d*)\.(?:0|[1-9]\d*)-rc(?:0|[1-9]\d*)$/'
      when: on_success

yandex:logger-staging:
  stage: deploy
  variables:
    RELEASE_NAME: ${CI_PROJECT_NAME}-logger
    HELM_PATH: ops/Helm/${CI_PROJECT_NAME}-logger
    REGISTRY: ${CI_REGISTRY_IMAGE}/logger
    HELM_ARG: '--set serviceAccount.create=false --set deploy.podAnnotations[0].app\.gitlab\.com\/env=$CI_ENVIRONMENT_SLUG --set deploy.podAnnotations[1].app\.gitlab\.com\/app=$CI_PROJECT_PATH_SLUG'

    ENVIRONMENT_NAME: yandex-staging
    ENVIRONMENT_URL: http://example.com
  trigger:
    include:
      - local: 'ops/pipelines/deploy.yml'
    strategy: depend
  needs:
    - trigger:build_logger
  rules:
    - if: '$CI_COMMIT_TAG =~ /^(?:0|[1-9]\d*)\.(?:0|[1-9]\d*)\.(?:0|[1-9]\d*)-rc(?:0|[1-9]\d*)$/'
      when: on_success

yandex:ui-staging:
  stage: deploy
  variables:
    RELEASE_NAME: ${CI_PROJECT_NAME}-ui
    HELM_PATH: ops/Helm/${CI_PROJECT_NAME}-ui
    REGISTRY: ${CI_REGISTRY_IMAGE}/ui-nuxt
    HELM_ARG: '--set serviceAccount.create=false --set deploy.podAnnotations[0].app\.gitlab\.com\/env=$CI_ENVIRONMENT_SLUG --set deploy.podAnnotations[1].app\.gitlab\.com\/app=$CI_PROJECT_PATH_SLUG'

    ENVIRONMENT_NAME: yandex-staging
    ENVIRONMENT_URL: http://example.com
  trigger:
    include:
      - local: 'ops/pipelines/ui.yml'
    strategy: depend
  needs:
    - trigger:build_ui
  rules:
    - if: '$CI_COMMIT_TAG =~ /^(?:0|[1-9]\d*)\.(?:0|[1-9]\d*)\.(?:0|[1-9]\d*)-rc(?:0|[1-9]\d*)$/'
      when: on_success

# YANDEX PRODUCTION RELEASE ============================================================================================
yandex:api-production:
  stage: deploy
  variables:
    RELEASE_NAME: ${CI_PROJECT_NAME}-api
    HELM_PATH: ops/Helm/${CI_PROJECT_NAME}-api
    REGISTRY: ${CI_REGISTRY_IMAGE}/api
    HELM_ARG: '--set deploy.podAnnotations[0].app\.gitlab\.com\/env=$CI_ENVIRONMENT_SLUG --set deploy.podAnnotations[1].app\.gitlab\.com\/app=$CI_PROJECT_PATH_SLUG'

    ENVIRONMENT_NAME: yandex-production
    ENVIRONMENT_URL: https://example.com
  trigger:
    include:
      - local: 'ops/pipelines/deploy.yml'
    strategy: depend
  needs:
    - trigger:build_api
  rules:
    - if: '$CI_COMMIT_TAG =~ /^(?:0|[1-9]\d*)\.(?:0|[1-9]\d*)\.(?:0|[1-9]\d*)\.?(?:0|[1-9]\d*)?$/'
      when: on_success

yandex:logger-production:
  stage: deploy
  variables:
    RELEASE_NAME: ${CI_PROJECT_NAME}-logger
    HELM_PATH: ops/Helm/${CI_PROJECT_NAME}-logger
    REGISTRY: ${CI_REGISTRY_IMAGE}/logger
    HELM_ARG: '--set serviceAccount.create=false --set deploy.podAnnotations[0].app\.gitlab\.com\/env=$CI_ENVIRONMENT_SLUG --set deploy.podAnnotations[1].app\.gitlab\.com\/app=$CI_PROJECT_PATH_SLUG'

    ENVIRONMENT_NAME: yandex-production
    ENVIRONMENT_URL: https://example.com
  trigger:
    include:
      - local: 'ops/pipelines/deploy.yml'
    strategy: depend
  needs:
    - trigger:build_logger
  rules:
    - if: '$CI_COMMIT_TAG =~ /^(?:0|[1-9]\d*)\.(?:0|[1-9]\d*)\.(?:0|[1-9]\d*)\.?(?:0|[1-9]\d*)?$/'
      when: on_success

yandex:ui-production:
  stage: deploy
  variables:
    RELEASE_NAME: ${CI_PROJECT_NAME}-ui
    HELM_PATH: ops/Helm/${CI_PROJECT_NAME}-ui
    REGISTRY: ${CI_REGISTRY_IMAGE}/ui-nuxt
    HELM_ARG: '--set serviceAccount.create=false --set deploy.podAnnotations[0].app\.gitlab\.com\/env=$CI_ENVIRONMENT_SLUG --set deploy.podAnnotations[1].app\.gitlab\.com\/app=$CI_PROJECT_PATH_SLUG'

    ENVIRONMENT_NAME: yandex-production
    ENVIRONMENT_URL: example.com
  trigger:
    include:
      - local: 'ops/pipelines/ui.yml'
    strategy: depend
  needs:
    - trigger:build_ui
  rules:
    - if: '$CI_COMMIT_TAG =~ /^(?:0|[1-9]\d*)\.(?:0|[1-9]\d*)\.(?:0|[1-9]\d*)\.?(?:0|[1-9]\d*)?$/'
      when: on_success
