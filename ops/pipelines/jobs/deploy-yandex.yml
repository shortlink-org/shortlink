include:
  - local: /ops/pipelines/templates/deploy.yml

# STAGING RELEASE ======================================================================================================

api:staging:
  extends:
    - .job_template_deploy
  variables:
    RELEASE_NAME: ${CI_PROJECT_NAME}-api
    HELM_PATH: ops/Helm/${CI_PROJECT_NAME}-api
    REGISTRY: ${CI_REGISTRY_IMAGE}/api
  environment:
    name: yandex-staging
    url: https://example.com
  needs:
    - trigger:build_api
  rules:
    - if: '$CI_COMMIT_TAG =~ /^(?:0|[1-9]\d*)\.(?:0|[1-9]\d*)\.(?:0|[1-9]\d*)-rc(?:0|[1-9]\d*)$/'
      when: manual

logger:staging:
  extends:
    - .job_template_deploy
  variables:
    RELEASE_NAME: ${CI_PROJECT_NAME}-logger
    HELM_PATH: ops/Helm/${CI_PROJECT_NAME}-logger
    REGISTRY: ${CI_REGISTRY_IMAGE}/logger
    HELM_ARG: "--set serviceAccount.create=false"
  environment:
    name: yandex-staging
    url: https://example.com
  allow_failure: true
  needs:
    - trigger:build_logger
  rules:
    - if: '$CI_COMMIT_TAG =~ /^(?:0|[1-9]\d*)\.(?:0|[1-9]\d*)\.(?:0|[1-9]\d*)-rc(?:0|[1-9]\d*)$/'
      when: manual

trigger:ui-staging:
  stage: deploy
  variables:
    ENVIRONMENT_NAME: yandex-staging
    ENVIRONMENT_URL: http://example.com
  trigger:
    include:
      - local: 'ops/pipelines/ui.yml'
    strategy: depend
  allow_failure: false
  needs:
    - trigger:build_ui
    - gosec
    - gotest
    - golint
  rules:
    - if: '$CI_COMMIT_TAG =~ /^(?:0|[1-9]\d*)\.(?:0|[1-9]\d*)\.(?:0|[1-9]\d*)-rc(?:0|[1-9]\d*)$/'
      when: manual

# PRODUCTION RELEASE ===================================================================================================

api:production:
  extends:
    - .job_template_deploy
  variables:
    RELEASE_NAME: ${CI_PROJECT_NAME}-api
    HELM_PATH: ops/Helm/${CI_PROJECT_NAME}-api
    REGISTRY: ${CI_REGISTRY_IMAGE}/api
  environment:
    name: yandex-production
    url: https://example.com
  allow_failure: false
  needs:
    - trigger:build_api
  rules:
    - if: '$CI_COMMIT_TAG =~ /^(?:0|[1-9]\d*)\.(?:0|[1-9]\d*)\.(?:0|[1-9]\d*)\.?(?:0|[1-9]\d*)?$/'
      when: manual

logger:production:
  extends:
    - .job_template_deploy
  variables:
    RELEASE_NAME: ${CI_PROJECT_NAME}-logger
    HELM_PATH: ops/Helm/${CI_PROJECT_NAME}-logger
    REGISTRY: ${CI_REGISTRY_IMAGE}/logger
    HELM_ARG: "--set serviceAccount.create=false"
  environment:
    name: yandex-production
    url: https://example.com
  allow_failure: false
  needs:
    - trigger:build_logger
  rules:
    - if: '$CI_COMMIT_TAG =~ /^(?:0|[1-9]\d*)\.(?:0|[1-9]\d*)\.(?:0|[1-9]\d*)\.?(?:0|[1-9]\d*)?$/'
      when: manual

trigger:ui-production:
  stage: deploy
  variables:
    ENVIRONMENT_NAME: yandex-production
    ENVIRONMENT_URL: example.com
  trigger:
    include:
      - local: 'ops/pipelines/ui.yml'
    strategy: depend
  needs:
    - trigger:build_ui
  rules:
    - if: '$CI_COMMIT_TAG =~ /^(?:0|[1-9]\d*)\.(?:0|[1-9]\d*)\.(?:0|[1-9]\d*)\.?(?:0|[1-9]\d*)?$/'
      when: manual
