include:
  - template: Container-Scanning.gitlab-ci.yml

# DOCKER ===============================================================================================================
container_scanning:
  stage: .pre
  variables:
    CI_APPLICATION_REPOSITORY: registry.gitlab.com/shortlink1/shortlink/logger
    CI_APPLICATION_TAG: 0.5.0-rc21
    DOCKERFILE_PATH: ops/dockerfile/logger.Dockerfile
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

# K8S ==================================================================================================================
helm-lint-chart:
  stage: qa
  image: quay.io/helmpack/chart-testing
  script:
    - ct lint --all --config ct.yaml

helm-run-chart:
  stage: qa
  image: quay.io/helmpack/chart-testing
  variables:
    KIND: v0.7.0
  before_script:
    - apk add -U docker
    - wget -O /usr/local/bin/kind https://github.com/kubernetes-sigs/kind/releases/download/${KIND}/kind-linux-amd64
    - chmod +x /usr/local/bin/kind
    - kind create cluster --wait 2m --config=./ops/Helm/kind-config.yaml
    - sed -i -E -e 's/localhost|0\.0\.0\.0/docker/g' "$HOME/.kube/config"
  script:
    - ct install --all --config ct.yaml
  only:
    refs:
      - tags
