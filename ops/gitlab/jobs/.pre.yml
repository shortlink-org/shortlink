include:
  - local: /ops/gitlab/workflows/matrix_deploy.yml

# ANSIBLE ==============================================================================================================
ansible-up:
  stage: .pre
  when: manual
  image: quay.io/ansible/molecule:latest
  script:
    - make ansible-up

# TERRAFORM ============================================================================================================
terraform-up:
  stage: .pre
  trigger:
    include:
      - local: 'ops/gitlab/pipelines/terraform.yml'
    strategy: depend
  rules:
    - changes:
        - ops/terraform/*

# K8S ==================================================================================================================
ADDITIONAL_HELM:
  stage: .pre
  trigger:
    include:
      - local: 'ops/gitlab/pipelines/additional_helm.yml'
    strategy: depend
  rules:
    - when: manual
#    - if: $CI_COMMIT_TAG
#      when: manual


test:
  stage: .pre
  variables:
    RELEASE_NAME: ${CI_PROJECT_NAME}-logger
    HELM_PATH: ops/Helm/${CI_PROJECT_NAME}-logger
    REGISTRY: ${CI_REGISTRY_IMAGE}/logger
    HELM_ARG: '--set serviceAccount.create=false --set deploy.annotations.app\.gitlab\.com\/env=$CI_ENVIRONMENT_SLUG --set deploy.annotations.app\.gitlab\.com\/app=$CI_PROJECT_PATH_SLUG'
  trigger:
    include:
      - local: 'ops/gitlab/pipelines/helm_deploy.yml'
    strategy: depend
  needs: []
  rules:
    - when: always
