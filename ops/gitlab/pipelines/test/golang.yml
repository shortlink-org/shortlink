include:
  # https://gitlab.com/gitlab-org/gitlab-foss/-/blob/master/lib/gitlab/ci/templates/Security/Coverage-Fuzzing.gitlab-ci.yml
  - template: Security/Coverage-Fuzzing.gitlab-ci.yml
  - template: Jobs/Code-Intelligence.gitlab-ci.yml
  - local: /ops/gitlab/templates/common.yml
  - local: /ops/gitlab/templates/go.yml

code_intelligence_go:
  stage: .pre
  image: sourcegraph/scip-go:latest
  allow_failure: true # recommended
  script:
    - lsif-go
  artifacts:
    reports:
      lsif: dump.lsif
    expire_in: 14 days
  rules:
    - when: manual # very long-running job, only run manually

gotest:
  extends:
    - .go-cache
    - .job_teplate_go
  coverage: '/coverage: \d+.\d+% of statements/'
  variables:
    GOPATH: $CI_PROJECT_DIR/.go
    CGO_CFLAGS: "-g -O2 -Wno-return-local-addr"
  before_script:
    - mkdir -p .go
    - apk add --no-cache make git gcc musl-dev liburing
    - go install gotest.tools/gotestsum@latest
    # Load io_uring
    - apt-get update && apt-get install --no-install-recommends -y liburing-dev curl
  script:
    - $GOPATH/bin/gotestsum --junitfile report.xml --format testname -- -tags=unit ./internal/...
  allow_failure: true
  artifacts:
    when: always
    reports:
      junit: report.xml
    expire_in: 14 days
  needs: []
  rules:
    - when: always

golint:
  extends:
    - .go-cache
    - .job_teplate_go
  image:
    # We don't use the ready golangci-lint image because it doesn't support the last version of Golang.
    name: ${CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX}/golang:1.21-alpine
    entrypoint: [""]
  before_script:
    - wget -O- -nv https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s v1.55.2
    - mkdir -p .go
    - apk add --no-cache jq
    - go mod vendor
  script:
    # Write the code coverage report to gl-code-quality-report.json
    # and print linting issues to stdout in the format: path/to/file:line description
    - /go/bin/golangci-lint --out-format code-climate ./internal/... | tee gl-code-quality-report.json | jq -r '.[] | "\(.location.path):\(.location.lines.begin) \(.description)"'
  # TODO: Remove allow_failure when fixed dependencies problem with mongodb package
  allow_failure: true
  artifacts:
    reports:
      codequality: gl-code-quality-report.json
    paths:
      - gl-code-quality-report.json
    expire_in: 14 days
  needs: []
  rules:
    - when: always

go_fuzz_test:
  extends: .fuzz_base
  stage: test
  image: ${CI_DEPENDENCY_PROXY_GROUP_IMAGE_PREFIX}/golang:1.21-alpine
  variables:
    CI_SEED_CORPUS: './seed_corpus'
  before_script:
    - apk add --no-cache clang git
  script:
    # link package
    - GITLAB_COV_FUZZ_PATH=`pwd`
    - cd $CI_PROJECT_DIR/internal/boundaries/link/link/domain/link/v1
    - go-fuzz-build -libfuzzer -o link_fuzz_target.a .
    - clang -fsanitize=fuzzer link_fuzz_target.a -o link_fuzz_target
    - $GITLAB_COV_FUZZ_PATH/gitlab-cov-fuzz run --regression=$REGRESSION -- ./link_fuzz_target
  allow_failure: true
  needs: []
  rules:
    - when: always
