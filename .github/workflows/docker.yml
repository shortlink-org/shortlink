name: Docker CD

on:
  push:
    branches:
      - main  # Set a branch to deploy

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  Build-and-Push-Docker-Image:
    runs-on: ubuntu-latest
    name: Docker Build, Tag, Push

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Docker meta
      id: meta
      uses: docker/metadata-action@v4
      with:
        images: name/app

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push [api]
      uses: docker/build-push-action@v4
      with:
        files: ops/dockerfile/go.Dockerfile
        build-args:
          CMD_PATH: "./internal/services/api/cmd"
        context: .
        push: ${{ github.event_name != 'pull_request' }}
        tags: latest
        labels: ${{ steps.meta.outputs.labels }}

    - name: Build and push [metadata]
      uses: docker/build-push-action@v4
      with:
        files: ops/dockerfile/go.Dockerfile
        build-args:
          CMD_PATH: "./internal/services/metadata/cmd"
        context: .
        push: ${{ github.event_name != 'pull_request' }}
        tags: latest
        labels: ${{ steps.meta.outputs.labels }}

    - name: Build and push [logger]
      uses: docker/build-push-action@v4
      with:
        files: ops/dockerfile/go.Dockerfile
        build-args:
          CMD_PATH: "./internal/services/logger/cmd"
        context: .
        push: ${{ github.event_name != 'pull_request' }}
        tags: latest
        labels: ${{ steps.meta.outputs.labels }}

    - name: Build and push [csi]
      uses: docker/build-push-action@v4
      with:
        files: ops/dockerfile/csi.Dockerfile
        context: .
        push: ${{ github.event_name != 'pull_request' }}
        tags: latest
        labels: ${{ steps.meta.outputs.labels }}

    - name: Build and push [landing]
      uses: docker/build-push-action@v4
      with:
        files: ops/dockerfile/landing.Dockerfile
        context: .
        push: ${{ github.event_name != 'pull_request' }}
        tags: latest
        labels: ${{ steps.meta.outputs.labels }}

    # sign container images
    - name: Install cosign
      uses: sigstore/cosign-installer@dd6b2e2b610a11fd73dd187a43d57cc1394e35f9 # v3.0.5
      with:
        cosign-release: 'v1.13.1'
